@using System.Security.Claims
@model EinarTask.Models.ViewModels.TaskBoardViewModel
@{
    ViewData["Title"] = "Görev Panosu";
    Layout = "_LayoutTask";
}
<style>
    body {
        background-color: #f8f9fa;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .board {
        display: flex;
        gap: 20px;
        padding: 20px;
        overflow-x: auto;
    }

    .column {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        width: 300px;
        min-height: 500px;
        padding: 15px;
    }

    .column-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 10px;
        border-bottom: 2px solid #ff6347;
    }

    .column-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: #333;
    }

    .task-card {
        background-color: #fff;
        border: 1px solid #ddd;
        border-left: 5px solid #ff6347;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
        cursor: move;
        transition: transform 0.2s;
    }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

    .dropzone-highlight {
        background-color: #ffe5e5;
    }

    .add-task-btn {
        background-color: #ff6347;
        border: none;
        color: white;
        font-weight: bold;
    }

        .add-task-btn:hover {
            background-color: #e5533d;
        }

    .task-type-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
        margin-left: 5px;
    }
</style>


<div class="container-fluid">
    <h1 class="my-4 text-center" style="color: #ff6347;">Görev Panosu</h1>
    <div class="mb-3">
        <button class="btn add-task-btn" data-bs-toggle="modal" data-bs-target="#createTaskModal">+ Yeni Görev Ekle</button>
        <button class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#createNewTaskTypeModal">+ Yeni TaskType Ekle</button>
    </div>

    <div class="board">
        @foreach (var taskType in Model.TaskTypes ?? Enumerable.Empty<EinarTask.Models.TaskType>())
        {
            <div class="column" data-tasktype-id="@taskType.Id" ondragover="event.preventDefault()" ondrop="drop(event)">
                <div class="column-header">
                    <span class="column-title" contenteditable="true" onblur="updateTaskTypeName(@taskType.Id, this.innerText)">@taskType.Name</span>
                    <div>
                        <input type="color" value="@taskType.Color" onchange="updateTaskTypeColor(@taskType.Id, this.value)" class="task-type-color" />
                        <button class="btn btn-sm btn-warning ms-2" onclick="editTaskType(@taskType.Id)">Düzenle</button>
                        <button class="btn btn-sm btn-danger ms-2" onclick="deleteTaskType(@taskType.Id)">Sil</button>
                    </div>
                </div>
                <div class="task-list">
                    @foreach (var task in Model.AllTasks.Where(t => t.TaskTypeId == taskType.Id))
                    {
                        <div class="task-card" draggable="true" ondragstart="drag(event)" data-task-id="@task.Id">
                            <h6>@task.Title</h6>
                            <p class="small text-muted">@task.Description</p>
                            <small>Vade: @(task.DueDate?.ToString("dd MMM yyyy") ?? "Belirtilmedi")</small>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

<!-- Görev Ekle Modal -->
<div class="modal fade" id="createTaskModal" tabindex="-1" aria-labelledby="createTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #ff6347; color: white;">
                <h5 class="modal-title" id="createTaskModalLabel">Yeni Görev Ekle</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="createTaskModalBody">
                @await Html.PartialAsync("_CreateTaskModal", Model.NewTask)
            </div>
        </div>
    </div>
</div>

<!-- Yeni TaskType Ekle/Düzenle Modal -->
<div class="modal fade" id="createNewTaskTypeModal" tabindex="-1" aria-labelledby="createNewTaskTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #28a745; color: white;">
                <h5 class="modal-title" id="createNewTaskTypeModalLabel">Yeni TaskType</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="createNewTaskTypeModalBody">
                @await Html.PartialAsync("_CreateNewTaskTypeModal", Model.NewTaskType)
            </div>
        </div>
    </div>
</div>

<!-- JavaScript kısmı aynı kalabilir -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Sürükle-Bırak Fonksiyonları
    function drag(event) {
        event.dataTransfer.setData("taskId", event.target.getAttribute("data-task-id"));
    }

    function drop(event) {
        event.preventDefault();
        const taskId = event.dataTransfer.getData("taskId");
        const newTaskTypeId = event.target.closest(".column").getAttribute("data-tasktype-id");

        $.ajax({
            url: '/Tasks/UpdateTaskTypeId',
            type: 'POST',
            data: { taskId: taskId, newTaskTypeId: newTaskTypeId },
            headers: {
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert(response.message);
                }
            }
        });
    }

    // TaskType Adını Güncelle
    function updateTaskTypeName(taskTypeId, name) {
        $.ajax({
            url: '/Tasks/UpdateTaskType',
            type: 'POST',
            data: { id: taskTypeId, name: name, color: '' },
            headers: {
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (!response.success) {
                    alert(response.message);
                }
            }
        });
    }

    // TaskType Rengini Güncelle
    function updateTaskTypeColor(taskTypeId, color) {
        $.ajax({
            url: '/Tasks/UpdateTaskType',
            type: 'POST',
            data: { id: taskTypeId, name: '', color: color },
            headers: {
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (!response.success) {
                    alert(response.message);
                }
            }
        });
    }

    // TaskType Sil
    function deleteTaskType(taskTypeId) {
        if (confirm("Bu görev tipini silmek istediğinize emin misiniz?")) {
            $.ajax({
                url: '/Tasks/DeleteTaskType',
                type: 'POST',
                data: { id: taskTypeId },
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert(response.message);
                    }
                }
            });
        }
    }

    // TaskType Düzenle
    function editTaskType(taskTypeId) {
        var userId = '@User.FindFirstValue(ClaimTypes.NameIdentifier)';
        if (!userId || userId === '') {
            console.error('UserId bulunamadı!');
            return;
        }
        $.ajax({
            url: '/Tasks/CreateOrUpdateTaskType',
            type: 'GET',
            data: { id: taskTypeId, userId: userId },
            success: function (data) {
                $('#createNewTaskTypeModalBody').html(data);
                $('#createNewTaskTypeModal').modal('show');
            },
            error: function (xhr, status, error) {
                console.error('Partial view yüklenirken hata:', error);
                $('#createNewTaskTypeModalBody').html('<p>Hata oluştu, lütfen tekrar deneyin.</p>');
            }
        });
    }

    // Modal Açıldığında Partial View Yükle
    $('#createTaskModal').on('show.bs.modal', function () {
        var userId = '@User.FindFirstValue(ClaimTypes.NameIdentifier)';
        if (!userId || userId === '') {
            console.error('UserId bulunamadı!');
            $('#createTaskModalBody').html('<p>Kullanıcı kimliği alınamadı, lütfen giriş yapın.</p>');
            return;
        }
        $.ajax({
            url: '/Tasks/CreateTask',
            type: 'GET',
            data: { userId: userId },
            success: function (data) {
                $('#createTaskModalBody').html(data);
            },
            error: function (xhr, status, error) {
                console.error('Partial view yüklenirken hata:', error);
                $('#createTaskModalBody').html('<p>Hata oluştu, lütfen tekrar deneyin. Detaylar konsolda.</p>');
            }
        });
    });

    // Yeni TaskType Modal Açıldığında
    $('#createNewTaskTypeModal').on('show.bs.modal', function () {
        var userId = '@User.FindFirstValue(ClaimTypes.NameIdentifier)';
        if (!userId || userId === '') {
            console.error('UserId bulunamadı!');
            $('#createNewTaskTypeModalBody').html('<p>Kullanıcı kimliği alınamadı, lütfen giriş yapın.</p>');
            return;
        }
        $.ajax({
            url: '/Tasks/CreateOrUpdateTaskType',
            type: 'GET',
            data: { userId: userId },
            success: function (data) {
                $('#createNewTaskTypeModalBody').html(data);
            },
            error: function (xhr, status, error) {
                console.error('Partial view yüklenirken hata:', error);
                $('#createNewTaskTypeModalBody').html('<p>Hata oluştu, lütfen tekrar deneyin. Detaylar konsolda.</p>');
            }
        });
    });


    // Form Gönderimleri
    $(document).on('submit', '#createTaskForm', function (e) {
        e.preventDefault();
        var formData = $(this).serialize();
        $.ajax({
            url: '/Tasks/CreateTask',
            type: 'POST',
            data: formData,
            headers: {
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    $('#createTaskModal').modal('hide');
                    location.reload();
                } else {
                    $('#formErrors').html('<ul>' + response.errors.map(e => '<li>' + e + '</li>').join('') + '</ul>');
                }
            },
            error: function (xhr, status, error) {
                console.log('Hata:', error);
                $('#formErrors').html('<ul><li>Bir hata oluştu, lütfen tekrar deneyin.</li></ul>');
            }
        });
    });

    $(document).on('submit', '#createTaskTypeForm', function (e) {
        e.preventDefault();
        var formData = $(this).serialize();
        $.ajax({
            url: '/Tasks/CreateOrUpdateTaskType',
            type: 'POST',
            data: formData,
            headers: {
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    $('#createNewTaskTypeModal').modal('hide');
                    location.reload();
                } else {
                    $('#formErrors').html('<ul><li>' + response.message + '</li></ul>');
                }
            },
            error: function (xhr, status, error) {
                console.log('Hata:', error);
                $('#formErrors').html('<ul><li>Bir hata oluştu, lütfen tekrar deneyin.</li></ul>');
            }
        });
    });
</script>